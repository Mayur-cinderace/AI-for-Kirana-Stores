<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirana Store - Receipt Items</title>
    <link rel="icon" href="data:;base64,=">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'bounce-gentle': 'bounce-gentle 3s ease-in-out infinite',
                        'fade-in': 'fade-in 0.8s ease-out',
                        'slide-up': 'slide-up 0.6s ease-out',
                        'spin-slow': 'spin 2s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'shake': 'shake 0.5s ease-in-out',
                    },
                    keyframes: {
                        'bounce-gentle': {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-8px)' },
                        },
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'translateY(30px) scale(0.95)' },
                            '100%': { opacity: '1', transform: 'translateY(0px) scale(1)' },
                        },
                        'slide-up': {
                            '0%': { opacity: '0', transform: 'translateY(40px) scale(0.95)' },
                            '100%': { opacity: '1', transform: 'translateY(0px) scale(1)' },
                        },
                        'float': {
                            '0%, 100%': { transform: 'translateY(0px) rotate(0deg)' },
                            '33%': { transform: 'translateY(-10px) rotate(1deg)' },
                            '66%': { transform: 'translateY(-5px) rotate(-1deg)' },
                        },
                        'glow': {
                            '0%': { 'box-shadow': '0 0 20px rgba(16, 185, 129, 0.3)' },
                            '100%': { 'box-shadow': '0 0 30px rgba(16, 185, 129, 0.6)' },
                        },
                        'shake': {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '25%': { transform: 'translateX(-5px)' },
                            '75%': { transform: 'translateX(5px)' },
                        }
                    }
                }
            },
            darkMode: 'class'
        }
    </script>

    <style>
        .glassmorphism {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .dark .glassmorphism {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .success-animation {
            animation: pulse 0.6s ease-in-out;
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .dark .card-hover:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .input-focus {
            transition: all 0.3s ease;
        }

        .input-focus:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .button-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .button-hover:hover {
            transform: translateY(-1px);
        }

        .button-hover:active {
            transform: translateY(0);
        }

        .button-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .button-hover:hover::before {
            left: 100%;
        }

        .status-dot {
            animation: pulse 2s infinite;
        }

        .item-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .item-card:hover {
            border-left-color: #10b981;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%);
        }

        .dark .item-card:hover {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .upload-zone {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }

        .upload-zone:hover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .dark .upload-zone {
            border-color: #4b5563;
        }

        .dark .upload-zone:hover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .modal {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>

<body
    class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 min-h-screen transition-all duration-500">
    <!-- Enhanced Header -->
    <header class="glassmorphism sticky top-0 z-50 px-6 py-4 border-b border-white/20">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <div
                        class="w-12 h-12 bg-gradient-to-br from-emerald-500 via-teal-500 to-cyan-500 rounded-xl flex items-center justify-center text-white font-bold text-xl animate-float shadow-lg">
                        üè™
                    </div>
                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-400 rounded-full status-dot"></div>
                </div>
                <div>
                    <h1
                        class="text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 dark:from-white dark:to-gray-200 bg-clip-text text-transparent">
                        Kirana Store
                    </h1>
                    <p class="text-sm text-gray-600 dark:text-gray-300 font-medium">Receipt Processing System</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div id="backendStatus"
                    class="flex items-center space-x-3 text-sm bg-white/10 dark:bg-black/20 px-3 py-2 rounded-full">
                    <div class="w-3 h-3 bg-gray-400 rounded-full animate-pulse"></div>
                    <span class="text-gray-600 dark:text-gray-400 font-medium">Checking...</span>
                </div>
                <a href="inventory.html" id="viewInventoryBtn"
                    class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-all duration-200 text-sm font-medium">
                    ‚Üê Back to Dashboard
                </a>
                <button id="themeToggle"
                    class="p-3 rounded-xl glassmorphism hover:bg-white hover:bg-opacity-20 transition-all duration-300 group">
                    <span class="text-xl group-hover:scale-110 transition-transform duration-200">üåô</span>
                </button>

            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-8 space-y-8">
        <!-- Enhanced Upload Section -->
        <div class="glassmorphism rounded-3xl p-8 animate-fade-in card-hover">
            <div class="flex items-center space-x-4 mb-8">
                <div
                    class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
                    <span class="text-white text-xl">üì§</span>
                </div>
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Upload Receipt</h2>
                    <p class="text-gray-600 dark:text-gray-300 mt-1">Upload your receipt image to extract items
                        automatically</p>
                </div>
            </div>

            <div class="flex flex-col items-center space-y-6">
                <div class="upload-zone w-full max-w-2xl p-8 rounded-2xl text-center">
                    <div class="mb-4">
                        <div
                            class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <span class="text-white text-2xl">üì∑</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Choose Receipt Image</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Supports JPG, PNG, and other image formats
                        </p>
                    </div>
                    <input type="file" id="receiptImage" accept="image/*"
                        class="w-full max-w-md px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all duration-300 input-focus file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 dark:file:bg-emerald-900 dark:file:text-emerald-300">
                </div>

                <button id="processImage"
                    class="px-8 py-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-xl font-semibold hover:from-emerald-600 hover:to-teal-700 transform hover:scale-105 transition-all duration-300 shadow-xl hover:shadow-2xl disabled:opacity-50 disabled:transform-none disabled:cursor-not-allowed button-hover text-lg">
                    <div class="flex items-center space-x-3">
                        <span id="buttonText">üîç Process Receipt</span>
                        <span id="loadingSpinner"
                            class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin-slow"></span>
                    </div>
                </button>

                <div id="imagePreview" class="hidden max-w-2xl w-full">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                        <span
                            class="w-6 h-6 bg-blue-500 rounded-lg flex items-center justify-center text-white text-sm mr-3">üëÅÔ∏è</span>
                        Image Preview
                    </h3>
                    <div class="rounded-2xl overflow-hidden shadow-2xl border border-white/20">
                        <img id="previewImg" class="w-full h-auto" alt="Receipt Preview">
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Extracted Items Section -->
        <div id="extractedItemsSection" class="hidden glassmorphism rounded-3xl p-8 animate-slide-up card-hover">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center space-x-4">
                    <div
                        class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-white text-xl">üìã</span>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Receipt Items</h2>
                        <p class="text-gray-600 dark:text-gray-300">Enter quantities for each extracted item</p>
                    </div>
                </div>
                <div id="itemCount"
                    class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-lg">
                </div>
            </div>

            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4 mb-6">
                <div class="flex items-center space-x-3">
                    <span class="text-blue-500 text-xl">üí°</span>
                    <p class="text-blue-800 dark:text-blue-200 font-medium">
                        Please review the extracted items and enter appropriate quantities, then click 'Submit
                        Quantities' to save.
                    </p>
                </div>
            </div>

            <div id="extractedItemsList" class="space-y-4 mb-8">
                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                    <div
                        class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">üì¶</span>
                    </div>
                    <p class="font-medium">No items extracted yet</p>
                </div>
            </div>

            <div class="flex justify-end space-x-4">
                <button id="submitQuantities"
                    class="px-8 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-semibold hover:from-blue-600 hover:to-indigo-700 transform hover:scale-105 transition-all duration-300 shadow-xl hover:shadow-2xl disabled:opacity-50 disabled:transform-none disabled:cursor-not-allowed button-hover text-lg"
                    disabled>
                    <div class="flex items-center space-x-3">
                        <span>‚úÖ Submit Quantities</span>
                    </div>
                </button>
                <button id="generateBill"
                    class="hidden px-8 py-4 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-teal-700 transform hover:scale-105 transition-all duration-300 shadow-xl hover:shadow-2xl button-hover text-lg">
                    <div class="flex items-center space-x-3">
                        <span>üìÑ Generate Bill</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Bill Modal -->
        <div id="billModal" class="hidden fixed inset-0 modal flex items-center justify-center z-50">
            <div class="modal-content glassmorphism rounded-3xl p-8 max-w-3xl w-full bg-white dark:bg-slate-800">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Generated Bill</h2>
                    <button id="closeBillModal"
                        class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                        <span class="text-2xl">‚úï</span>
                    </button>
                </div>
                <div id="billContent"
                    class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
                    <p class="text-center text-gray-500 dark:text-gray-400">Loading bill...</p>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="downloadBill"
                        class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-xl font-semibold hover:from-emerald-600 hover:to-teal-700 transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl button-hover">
                        Download Bill (PDF)
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Debug Section -->
        <div id="debugSection" class="hidden glassmorphism rounded-3xl p-8 animate-slide-up card-hover">
            <div class="flex items-center space-x-4 mb-6">
                <div
                    class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg">
                    <span class="text-white text-xl">üîç</span>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800 dark:text-white">Raw OCR Results</h3>
                    <p class="text-gray-600 dark:text-gray-300">Debug information from text extraction</p>
                </div>
            </div>
            <div id="rawOcrResults"
                class="bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-gray-700 p-6 rounded-xl font-mono text-sm max-h-48 overflow-y-auto shadow-inner">
            </div>
        </div>
    </div>

    <!-- Enhanced Success Toast -->
    <div id="successToast"
        class="fixed top-6 right-6 bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-x-full transition-all duration-300 z-50 border border-white/20">
        <div class="flex items-center space-x-3">
            <span class="text-xl">‚úÖ</span>
            <div>
                <p class="font-semibold" id="successMessage">Receipt processed successfully!</p>
            </div>
        </div>
    </div>

    <!-- Enhanced Error Toast -->
    <div id="errorToast"
        class="fixed top-6 right-6 bg-gradient-to-r from-red-500 to-pink-600 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-x-full transition-all duration-300 z-50 border border-white/20">
        <div class="flex items-center space-x-3">
            <span class="text-xl">‚ùå</span>
            <div>
                <p class="font-semibold" id="errorMessage">An error occurred!</p>
            </div>
        </div>
    </div>

    <script>
        class CustomerListDisplay {
            constructor() {
                this.extractedItems = [];
                this.isDarkMode = false;
                this.backendUrl = 'http://127.0.0.1:49285';
                this.initializeEventListeners();
                this.checkBackendStatus();
            }

            initializeEventListeners() {
                console.log("Initializing event listeners...");
                document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());
                document.getElementById('receiptImage').addEventListener('change', (e) => this.previewImage(e));
                document.getElementById('processImage').addEventListener('click', () => this.processImage());
                document.getElementById('submitQuantities').addEventListener('click', () => this.submitQuantities());
                document.getElementById('extractedItemsList').addEventListener('input', (e) => {
                    if (e.target.classList.contains('quantity-input')) {
                        this.updateSubmitButtonState();
                    }
                });
                document.getElementById('generateBill')?.addEventListener('click', () => this.generateBill());
                document.getElementById('closeBillModal')?.addEventListener('click', () => this.closeBillModal());
                document.getElementById('downloadBill')?.addEventListener('click', () => this.downloadBill());
            }

            async checkBackendStatus() {
                const statusElement = document.getElementById('backendStatus');
                try {
                    const response = await fetch(`${this.backendUrl}/health`);
                    const data = await response.json();
                    if (response.ok) {
                        statusElement.innerHTML = `
                            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-green-600 dark:text-green-400 font-semibold">Backend Online</span>
                        `;
                    } else {
                        throw new Error('Backend not healthy');
                    }
                } catch (error) {
                    statusElement.innerHTML = `
                        <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                        <span class="text-red-600 dark:text-red-400 font-semibold">Backend Offline</span>
                    `;
                    console.error('Backend health check failed:', error);
                }
            }

            toggleTheme() {
                this.isDarkMode = !this.isDarkMode;
                const html = document.documentElement;
                const toggle = document.getElementById('themeToggle');
                if (this.isDarkMode) {
                    html.classList.add('dark');
                    toggle.innerHTML = '<span class="text-xl group-hover:scale-110 transition-transform duration-200">‚òÄÔ∏è</span>';
                } else {
                    html.classList.remove('dark');
                    toggle.innerHTML = '<span class="text-xl group-hover:scale-110 transition-transform duration-200">üåô</span>';
                }
            }

            previewImage(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('imagePreview');
                    const img = document.getElementById('previewImg');
                    img.src = e.target.result;
                    preview.classList.remove('hidden');
                    preview.classList.add('animate-fade-in');
                };
                reader.readAsDataURL(file);
            }

            async processImage() {
                const fileInput = document.getElementById('receiptImage');
                const button = document.getElementById('processImage');
                const buttonText = document.getElementById('buttonText');
                const loadingSpinner = document.getElementById('loadingSpinner');

                if (!fileInput.files[0]) {
                    this.showToast('error', 'Please select an image to process');
                    button.classList.add('animate-shake');
                    setTimeout(() => button.classList.remove('animate-shake'), 500);
                    return;
                }

                button.disabled = true;
                buttonText.textContent = '‚è≥ Processing...';
                loadingSpinner.classList.remove('hidden');

                try {
                    const formData = new FormData();
                    formData.append('receipt', fileInput.files[0]);

                    const response = await fetch(`${this.backendUrl}/upload-receipt`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to process receipt');
                    }

                    this.extractedItems = result.items;
                    this.total_items = result.total_items;
                    console.log("Extracted items:", this.extractedItems);

                    this.displayExtractedItems();
                    this.displayRawOcrResults(result.raw_ocr_results);
                    this.showToast('success', `üéâ Receipt processed successfully! Found ${result.items.length} items. Please enter quantities.`);
                } catch (error) {
                    console.error('Error processing receipt:', error);
                    this.showToast('error', error.message || 'Failed to process receipt. Make sure the backend is running.');
                } finally {
                    button.disabled = false;
                    buttonText.textContent = 'üîç Process Receipt';
                    loadingSpinner.classList.add('hidden');
                }
            }

            updateSubmitButtonState() {
                const inputs = document.querySelectorAll('.quantity-input');
                const submitButton = document.getElementById('submitQuantities');
                const generateBillButton = document.getElementById('generateBill');
                const hasValidInput = Array.from(inputs).some(input => {
                    const value = parseFloat(input.value);
                    return input.value !== '' && !isNaN(value) && value > 0;
                });
                submitButton.disabled = !hasValidInput;
                generateBillButton.classList.toggle('hidden', !hasValidInput);

                if (hasValidInput) {
                    submitButton.classList.add('animate-glow');
                } else {
                    submitButton.classList.remove('animate-glow');
                }

                console.log("Submit button state:", hasValidInput ? "Enabled" : "Disabled", "Inputs:", Array.from(inputs).map(i => i.value));
            }

            displayExtractedItems() {
                console.log("Rendering extracted items:", this.extractedItems);
                const itemsList = document.getElementById('extractedItemsList');
                const section = document.getElementById('extractedItemsSection');
                const itemCount = document.getElementById('itemCount');

                if (this.total_items === 0) {
                    itemsList.innerHTML = `
                        <div class="text-center text-gray-500 dark:text-gray-400 py-12">
                            <div class="w-20 h-20 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-3xl">üì¶</span>
                            </div>
                            <p class="font-semibold text-lg">No items extracted</p>
                            <p class="text-sm mt-2">Try uploading a clearer receipt image</p>
                        </div>
                    `;
                    section.classList.add('hidden');
                    this.updateSubmitButtonState();
                    return;
                }

                section.classList.remove('hidden');
                itemCount.textContent = `${this.extractedItems.length} items found`;

                itemsList.innerHTML = `
                    <div class="grid gap-4">
                        ${this.extractedItems.map((item, index) => `
                            <div class="item-card border border-gray-200 dark:border-gray-700 rounded-2xl p-6 bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm shadow-lg">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3 mb-4">
                                            <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center text-white font-bold">
                                                ${index + 1}
                                            </div>
                                            <h4 class="font-bold text-lg text-gray-900 dark:text-white">${item.item}</h4>
                                        </div>
                                        
                                        <div class="bg-gray-50 dark:bg-slate-700/50 rounded-xl p-4 mb-3">
                                            <div class="flex items-center space-x-4">
                                                <label class="font-semibold text-gray-700 dark:text-gray-300">Quantity:</label>
                                                <div class="flex items-center space-x-2">
                                                    <input type="number" step="0.01" min="0" 
                                                        class="quantity-input w-24 px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-200 font-semibold text-center" 
                                                        data-index="${index}" 
                                                        placeholder="0.00">
                                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400 bg-gray-200 dark:bg-gray-600 px-3 py-2 rounded-lg">
                                                        ${item.unit || 'unit'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3 border border-yellow-200 dark:border-yellow-800">
                                            <div class="flex items-center space-x-2 text-xs">
                                                <span class="text-yellow-600 dark:text-yellow-400">üéØ</span>
                                                <span class="text-yellow-800 dark:text-yellow-200 font-medium">
                                                    Match: ${(item.fuzzy_match?.similarity_score || 0).toFixed(3)} | 
                                                    Original: "${item.fuzzy_match?.original_extracted || 'N/A'}"
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                this.updateSubmitButtonState();
                document.querySelectorAll('.quantity-input').forEach(input => {
                    input.addEventListener('input', this.updateSubmitButtonState.bind(this));
                    input.addEventListener('focus', (e) => {
                        e.target.parentElement.parentElement.classList.add('ring-2', 'ring-emerald-500/20');
                    });
                    input.addEventListener('blur', (e) => {
                        e.target.parentElement.parentElement.classList.remove('ring-2', 'ring-emerald-500/20');
                    });
                });
            }

            async submitQuantities() {
                console.log("Submitting quantities...");
                const inputs = document.querySelectorAll('.quantity-input');
                const updatedItems = this.extractedItems.map((item, index) => {
                    const input = inputs[index];
                    const quantity = input.value ? parseFloat(input.value) : 1;
                    console.log(`Item: ${item.item}, Quantity: ${quantity}`);
                    if (quantity === null || isNaN(quantity) || quantity <= 0) {
                        throw new Error(`Invalid quantity for ${item.item}. Please enter a positive number.`);
                    }
                    return { ...item, quantity };
                });

                const button = document.getElementById('submitQuantities');
                button.disabled = true;
                button.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                        <span>Saving...</span>
                    </div>
                `;

                try {
                    const response = await fetch(`${this.backendUrl}/save-receipt-items`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: updatedItems })
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to save items');
                    }

                    this.extractedItems = result.items; // Update with enriched items including sellingPrice
                    this.displayExtractedItems();
                    this.showToast('success', 'üéâ Quantities saved successfully! Generating bill...');

                    // Automatically generate bill after successful submission
                    await this.generateBill();
                } catch (error) {
                    console.error('Error saving quantities:', error);
                    this.showToast('error', error.message || 'Failed to save quantities.');
                } finally {
                    button.disabled = false;
                    button.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span>‚úÖ Submit Quantities</span>
                        </div>
                    `;
                }
            }

            async generateBill() {
                const modal = document.getElementById('billModal');
                const billContent = document.getElementById('billContent');
                billContent.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Generating bill...</p>';

                modal.classList.remove('hidden');
                modal.classList.add('animate-fade-in');

                try {
                    const response = await fetch(`${this.backendUrl}/api/generate-bill`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: this.extractedItems })
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to generate bill');
                    }

                    billContent.innerHTML = result.html;
                    this.showToast('success', 'üéâ Bill generated successfully!');
                } catch (error) {
                    console.error('Error generating bill:', error);
                    billContent.innerHTML = '<p class="text-center text-red-500 dark:text-red-400">Failed to generate bill</p>';
                    this.showToast('error', error.message || 'Failed to generate bill.');
                }
            }

            closeBillModal() {
                const modal = document.getElementById('billModal');
                modal.classList.add('animate-fade-in');
                modal.style.transform = 'translateY(100%)';
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.style.transform = 'translateY(0)';
                    modal.classList.remove('animate-fade-in');
                }, 300);
            }

            downloadBill() {
                // Placeholder for PDF download (handled by backend LaTeX generation)
                this.showToast('success', 'üì• Bill download initiated!');
            }

            displayRawOcrResults(rawResults) {
                if (!rawResults || rawResults.length === 0) return;

                const debugSection = document.getElementById('debugSection');
                const rawOcrResults = document.getElementById('rawOcrResults');

                debugSection.classList.remove('hidden');
                rawOcrResults.innerHTML = rawResults.map((result, index) => `
                    <div class="mb-2 p-2 bg-white dark:bg-slate-900 rounded-lg border border-gray-200 dark:border-gray-700">
                        <span class="text-blue-600 dark:text-blue-400 font-semibold">${index + 1}:</span> 
                        <span class="text-gray-800 dark:text-gray-200">${result.text}</span>
                        <span class="text-emerald-600 dark:text-emerald-400 ml-2 text-xs">
                            (Confidence: ${result.confidence.toFixed(2)})
                        </span>
                    </div>
                `).join('');
            }

            showToast(type, message) {
                const toast = document.getElementById(type + 'Toast');
                if (type === 'success') {
                    document.getElementById('successMessage').textContent = message;
                } else {
                    document.getElementById('errorMessage').textContent = message;
                }

                toast.style.transform = 'translateX(0)';
                toast.classList.add('animate-fade-in');

                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.classList.remove('animate-fade-in'), 300);
                }, 5000);
            }
        }

        // Initialize the application
        const customerListDisplay = new CustomerListDisplay();
    </script>
</body>

</html>